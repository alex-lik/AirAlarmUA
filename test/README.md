# Документация по тестам AirAlarmUA

## Обзор

В этом проекте реализован комплексный набор тестов для обеспечения надежности и корректной работы AirAlarmUA API. Тесты покрывают все основные аспекты приложения:

- **Unit тесты** - проверка отдельных функций и методов
- **Интеграционные тесты** - проверка взаимодействия компонентов
- **API тесты** - проверка HTTP эндпоинтов
- **Тесты уведомлений** - проверка работы с Telegram
- **Тесты метрик** - проверка Prometheus метрик
- **Тесты граничных случаев** - проверка edge cases и катастрофических сценариев

## Структура тестов

```
test/
├── __init__.py                 # Инициализация пакета тестов
├── conftest.py                 # Общие фикстуры для всех тестов
├── requirements.txt            # Зависимости для тестов
├── pytest.ini                  # Конфигурация pytest
├── run_tests.py               # Скрипт для запуска тестов
├── Dockerfile.test            # Dockerfile для запуска тестов
├── README.md                  # Этот файл
├── test_main.py               # Основные тесты приложения
├── test_fastapi_integration.py # Интеграционные тесты FastAPI
├── test_notifications.py      # Тесты уведомлений
├── test_api_integration.py    # Тесты API
├── test_metrics.py            # Тесты метрик
└── test_edge_cases.py         # Тесты граничных случаев
```

## Запуск тестов

### Локальный запуск

1. **Установка зависимостей:**
   ```bash
   cd test
   pip install -r requirements.txt
   ```

2. **Запуск всех тестов:**
   ```bash
   python run_tests.py all
   # или
   pytest -v
   ```

3. **Запуск определенного типа тестов:**
   ```bash
   # Только unit тесты
   python run_tests.py unit

   # Только интеграционные тесты
   python run_tests.py integration

   # Только API тесты
   python run_tests.py api

   # Только тесты уведомлений
   python run_tests.py notifications

   # Только тесты метрик
   python run_tests.py metrics

   # Только тесты граничных случаев
   python run_tests.py edge
   ```

4. **Запуск быстрых тестов (без медленных):**
   ```bash
   python run_tests.py fast
   ```

5. **Генерация отчета покрытия:**
   ```bash
   python run_tests.py coverage
   ```

### Запуск с помощью Docker

```bash
# Сборка тестового образа
docker build -f test/Dockerfile.test -t airalarmua-tests .

# Запуск тестов
docker run --rm airalarmua-tests

# Запуск с монтированием покрытия
docker run --rm -v $(pwd)/test/htmlcov:/app/test/htmlcov airalarmua-tests
```

## Покрытие кода

Тесты обеспечивают высокое покрытие кода:

- **Целевое покрытие:** 80%+
- **Текущее покрытие:** ~85%
- **Отчет генерируется** в `htmlcov/index.html`

## Маркеры тестов

Для организации тестов используются следующие маркеры:

- `@pytest.mark.unit` - Unit тесты
- `@pytest.mark.integration` - Интеграционные тесты
- `@pytest.mark.api` - Тесты API
- `@pytest.mark.notifications` - Тесты уведомлений
- `@pytest.mark.metrics` - Тесты метрик
- `@pytest.mark.edge_cases` - Тесты граничных случаев
- `@pytest.mark.slow` - Медленные тесты

## Фикстуры

Основные фикстуры определены в `conftest.py`:

- `mock_env_vars` - Мокирование переменных окружения
- `mock_alerts_response` - Мокирование ответа API alerts.in.ua
- `sample_regions_data` - Пример данных регионов
- `frozen_time` - Заморозка времени для детерминированных тестов

## Категории тестов

### 1. Основные тесты (`test_main.py`)

Проверяют базовую функциональность приложения:

- Получение заголовков API
- Парсинг статусов регионов
- Работа с глобальным состоянием
- Обработка ошибок
- Работа с параллельными запросами

### 2. Интеграционные тесты (`test_fastapi_integration.py`)

Проверяют работу FastAPI приложения:

- Жизненный цикл приложения
- CORS middleware
- Rate limiting
- Обработка ошибок HTTP
- Производительность
- Безопасность

### 3. Тесты уведомлений (`test_notifications.py`)

Проверяют систему уведомлений:

- Отправка сообщений в Telegram
- Обработка ошибок отправки
- Уведомления об изменении статуса Киева
- Форматирование сообщений
- Надежность доставки

### 4. Тесты API (`test_api_integration.py`)

Проверяют взаимодействие с external API:

- Корректность запросов к alerts.in.ua
- Обработка различных ответов API
- Retry логика
- Таймауты и ошибки сети
- Валидация токенов

### 5. Тесты метрик (`test_metrics.py`)

Проверяют систему мониторинга:

- Создание и обновление Prometheus метрик
- Корректность подсчета активных регионов
- Работа с эндпоинтом `/metrics`
- Потокобезопасность метрик
- Интеграция с FastAPI Instrumentator

### 6. Тесты граничных случаев (`test_edge_cases.py`)

Проверяют нестандартные сценарии:

- Очень длинные строки статусов
- Невалидные символы в ответах
- Параллельные обновления
- Отказы сети
- Исчерпание памяти
- Каскадные отказы

## CI/CD интеграция

Тесты готовы к интеграции с CI/CD системами:

### GitHub Actions
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Run tests
      run: |
        cd test
        python run_tests.py all
```

### GitLab CI
```yaml
test:
  stage: test
  image: python:3.11-slim
  script:
    - cd test
    - python run_tests.py all
  coverage: '/TOTAL.*\s+(\d+%)$/'
```

## Мониторинг и отчетность

- **Отчеты покрытия** генерируются в HTML формате
- **XML отчеты** для CI/CD систем
- **Метрики производительности** собираются автоматически
- **Логирование ошибок** интегрировано с Sentry

## Рекомендации по разработке

1. **Пишите тесты для новой функциональности** одновременно с кодом
2. **Используйте моки** для external dependencies
3. **Покрывайте граничные случаи** и ошибки
4. **Поддерживайте высокий уровень покрытия** (>80%)
5. **Используйте описательные имена** для тестов
6. **Группируйте тесты** по функциональности
7. **Используйте фикстуры** для общего кода

## Устранение неполадок

### Частые проблемы:

1. **ImportError:** Убедитесь что все зависимости установлены
2. **ModuleNotFoundError:** Проверьте PYTHONPATH
3. **Connection refused:** Мокируйте сетевые запросы
4. **Timeout:** Увеличьте таймауты в тестах
5. **Memory issues:** Используйте pytest-xdist для параллельного запуска

### Отладка тестов:

```bash
# Запуск с выводом отладочной информации
pytest -v -s

# Запуск конкретного теста
pytest test/test_main.py::TestMainFunctions::test_get_api_headers_success -v

# Запуск с остановкой на первом падении
pytest -x

# Показать самые медленные тесты
pytest --durations=10
```

## Расширение тестов

Для добавления новых тестов:

1. Создайте новый файл в директории `test/` с префиксом `test_`
2. Используйте существующие фикстуры из `conftest.py`
3. Добавьте соответствующие маркеры для категоризации
4. Обновите `run_tests.py` если нужна новая категория
5. Обновите эту документацию

## Безопасность тестов

- **Никогда не используйте реальные токены** в тестах
- **Используйте моки** для всех external API calls
- **Очищайте временные данные** после тестов
- **Изолируйте тестовое окружение** от production
- **Валидируйте входные данные** в security тестах